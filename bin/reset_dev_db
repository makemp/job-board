#!/usr/bin/env bash
set -euo pipefail

# Safety check: prevent running on production
if [ "${RAILS_ENV:-}" = "production" ] && [ -z "${STAGING_ENV:-}" ]; then
  echo "DO NOT RUN THIS SCRIPT ON PRODUCTION"
  exit 1
fi

# remove old schema dump (change to schema.rb or structure.sql as needed)
if [ -f db/schema.rb ]; then
  rm db/schema.rb
fi


if [ -f db/structure.sql ]; then
  rm db/structure.sql
fi


if [ -f db/analytics_structure.sql ]; then
  rm db/analytics_structure.sql
fi

# rebuild structure.sql files
rails db:drop
rails db:migrate
# completely rebuild the DB and run migrations
RAILS_ENV=test rails db:migrate



# seed the development dataset
rails db:seeds:dev