<%
  set_meta_tags(
    title: "Manage Your Job Alert - DrillCrew",
    description: "Update your job alert preferences or unsubscribe from notifications."
  )
%>

<div class="min-h-screen bg-amber-50">
  <div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="text-center mb-8">
      <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-amber-100 mb-4">
        <svg class="h-8 w-8 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5-5-5h5v-12"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 1h6v6h-6z"/>
        </svg>
      </div>
      <h1 class="text-2xl font-bold text-gray-900 mb-2">Manage Your Job Alerts</h1>
      <p class="text-gray-600">Update your preferences or unsubscribe below</p>
    </div>

    <div class="bg-white rounded-lg shadow-sm border border-amber-200 p-6 mb-6">
      <div class="flex items-center justify-center">
        <div class="text-center">
          <p class="text-sm text-gray-500"><%=@job_alert.email %> subscribed since:</p>
          <p class="text-sm font-medium text-gray-900"><%= @job_alert.created_at.strftime("%B %d, %Y") %></p>
        </div>
      </div>
    </div>

    <!-- Job Alert Filters Section -->
    <div class="bg-white rounded-lg shadow-sm border border-amber-200 p-6 mb-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-medium text-gray-900">Job Alerts</h3>
        <span class="text-sm text-gray-500"><%= pluralize(@job_alert.job_alert_filters.count, 'filter') %></span>
      </div>

      <% if @job_alert.job_alert_filters.any? %>
        <div class="space-y-4">
          <% @job_alert.job_alert_filters.each do |filter| %>
            <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
              <%= form_with model: filter, url: update_job_alert_filter_path(filter, @job_alert.management_token), method: :patch, local: true, class: "space-y-4" do |form| %>
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center space-x-2">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <%= filter.enabled? ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800' %>">
                      <svg class="mr-1.5 h-2 w-2 <%= filter.enabled? ? 'text-green-400' : 'text-gray-400' %>" fill="currentColor" viewBox="0 0 8 8">
                        <circle cx="4" cy="4" r="3"/>
                      </svg>
                      <%= filter.enabled? ? 'Enabled' : 'Disabled' %>
                    </span>
                  </div>

                  <div class="flex items-center space-x-2">
                    <%= link_to toggle_job_alert_filter_path(filter, @job_alert.management_token),
                              data: { "turbo-method": :patch },
                              class: "inline-flex items-center px-3 py-1 border border-gray-300 shadow-sm text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500" do %>
                      <%= filter.enabled? ? 'Disable' : 'Enable' %>
                    <% end %>
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <%= form.label :category, class: "block text-sm font-medium text-gray-700 mb-1" %>
                    <%= form.select :category,
                          options_for_select(selectable_grouped_categories, filter.category),
                          {},
                          { class: "block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500 sm:text-sm bg-white" } %>
                  </div>

                  <div>
                    <%= form.label :region, class: "block text-sm font-medium text-gray-700 mb-1" %>
                    <div class="w-full"
                         data-controller="searchable-select"
                         data-searchable-select-placeholder-value="Search regions...">

                      <div class="relative">
                        <%= text_field_tag "job_alert_filter[region_search]",
                                           filter.region,
                            class: "block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500 sm:text-sm bg-white",
                            placeholder: "Search regions...",
                            data: {
                              "searchable-select-target": "search",
                              action: "input->searchable-select#filterOptions focus->searchable-select#showDropdown blur->searchable-select#hideDropdownDelayed keydown->searchable-select#handleKeydown"
                            } %>

                        <div data-searchable-select-target="dropdown"
                             class="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto hidden">

                          <div class="px-3 py-2 cursor-pointer hover:bg-amber-100 text-gray-900 font-medium border-b border-gray-200"
                               data-searchable-select-target="option"
                               data-action="mousedown->searchable-select#selectAllRegions"
                               data-value=""
                               data-always-visible="true">
                          </div>

                          <div class="px-3 py-2 text-sm font-semibold text-gray-700 bg-gray-100 border-b">
                            Featured Regions
                          </div>
                          <% JobOffer::HIGHLIGHTED_REGIONS.each do |region| %>
                            <div class="px-3 py-2 cursor-pointer hover:bg-amber-100 text-gray-900 <%= 'bg-amber-200' if filter.region == region %>"
                                 data-searchable-select-target="option"
                                 data-action="mousedown->searchable-select#selectOption"
                                 data-value="<%= region %>">
                              <%= region %>
                            </div>
                          <% end %>

                          <div class="px-3 py-2 text-sm font-semibold text-gray-700 bg-gray-100 border-b">
                            Regions
                          </div>
                          <% (JobOffer::REGIONS - JobOffer::HIGHLIGHTED_REGIONS).each do |region| %>
                            <div class="px-3 py-2 cursor-pointer hover:bg-amber-100 text-gray-900 <%= 'bg-amber-200' if filter.region == region %>"
                                 data-searchable-select-target="option"
                                 data-action="mousedown->searchable-select#selectOption"
                                 data-value="<%= region %>">
                              <%= region %>
                            </div>
                          <% end %>
                        </div>
                      </div>


                      <%= form.select :region_search,
                          content_tag(:optgroup,
                            options_for_select(JobOffer::HIGHLIGHTED_REGIONS.map { |r| [r, r] }, selected: filter.region),
                            label: "Featured Regions"
                          ) +
                          content_tag(:optgroup,
                            options_for_select(JobOffer::REGIONS.reject { |r| JobOffer::HIGHLIGHTED_REGIONS.include?(r) }.map { |r| [r, r] }, selected: filter.region),
                            label: "Regions"
                          ),
                          { include_blank: "" },
                          {
                            class: "hidden",
                            data: { "searchable-select-target": "select" }
                          } %>
                    </div>
                  </div>

                  <div>
                    <%= form.label :frequency, class: "block text-sm font-medium text-gray-700 mb-1" %>
                    <%= form.select :frequency,
                          options_for_select([
                            ['Daily', 'daily'],
                            ['Weekly', 'weekly'],
                            ['Monthly', 'monthly']
                          ], filter.frequency),
                          {},
                          { class: "block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500 sm:text-sm bg-white" } %>
                  </div>
                </div>

                <div class="flex items-center justify-between pt-3 border-t border-gray-200">
                  <div class="text-xs text-gray-500">
                    Created: <%= filter.created_at.strftime("%B %d, %Y") %>
                  </div>

                  <div class="flex items-center space-x-2">
                    <%= link_to destroy_job_alert_filter_path(filter, @job_alert.management_token),
                              data: { "turbo-method": :delete, confirm: "Are you sure you want to delete this filter?" },
                              class: "inline-flex items-center px-3 py-1 border border-red-300 shadow-sm text-xs font-medium rounded text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500" do %>
                      <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                      </svg>
                      Delete
                    <% end %>

                    <%= form.hidden_field :management_token, value: @job_alert.management_token %>
                    <%= form.hidden_field :filter_id, value: filter.id %>


                    <%= form.submit "Save",
                          class: "inline-flex items-center px-4 py-1 border border-transparent shadow-sm text-xs font-medium rounded text-white bg-amber-600 hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500" %>
                  </div>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="text-center py-8">
          <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"/>
          </svg>
          <h3 class="mt-2 text-sm font-medium text-gray-900">No filters configured</h3>
          <p class="mt-1 text-sm text-gray-500">Get started by adding your first job alert filter.</p>
        </div>
      <% end %>

      <!-- Add New Filter Section -->
      <div class="mt-6 pt-6 border-t border-gray-200">
        <h4 class="text-sm font-medium text-gray-900 mb-3">Add New Filter</h4>
        <%= form_with model: [@job_alert, @job_alert.job_alert_filters.build], local: true, class: "space-y-4" do |form| %>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <%= form.label :category, class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= form.select :category,
                    options_for_select([['']] + selectable_grouped_categories),
                    {},
                    { class: "block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500 sm:text-sm bg-white" } %>
            </div>

            <div>
              <%= form.label :region, class: "block text-sm font-medium text-gray-700 mb-1" %>
              <div class="w-full"
                   data-controller="searchable-select"
                   data-searchable-select-placeholder-value="Search regions...">

                <div class="relative">
                  <%= text_field_tag "job_alert_filter[region_search]",
                                     @job_alert.job_alert_filters.build.region,
                    class: "block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500 sm:text-sm bg-white",
                    placeholder: "Search regions...",
                    data: {
                      "searchable-select-target": "search",
                      action: "input->searchable-select#filterOptions focus->searchable-select#showDropdown blur->searchable-select#hideDropdownDelayed keydown->searchable-select#handleKeydown"
                    } %>

                  <div data-searchable-select-target="dropdown"
                       class="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto hidden">

                    <div class="px-3 py-2 cursor-pointer hover:bg-amber-100 text-gray-900 font-medium border-b border-gray-200"
                         data-searchable-select-target="option"
                         data-action="mousedown->searchable-select#selectAllRegions"
                         data-value=""
                         data-always-visible="true">
                    </div>

                    <div class="px-3 py-2 text-sm font-semibold text-gray-700 bg-gray-100 border-b">
                      Featured Regions
                    </div>
                    <% JobOffer::HIGHLIGHTED_REGIONS.each do |region| %>
                      <div class="px-3 py-2 cursor-pointer hover:bg-amber-100 text-gray-900 <%= 'bg-amber-200' if @job_alert.job_alert_filters.build.region == region %>"
                           data-searchable-select-target="option"
                           data-action="mousedown->searchable-select#selectOption"
                           data-value="<%= region %>">
                        <%= region %>
                      </div>
                    <% end %>

                    <div class="px-3 py-2 text-sm font-semibold text-gray-700 bg-gray-100 border-b">
                      Regions
                    </div>
                    <% (JobOffer::REGIONS - JobOffer::HIGHLIGHTED_REGIONS).each do |region| %>
                      <div class="px-3 py-2 cursor-pointer hover:bg-amber-100 text-gray-900 <%= 'bg-amber-200' if @job_alert.job_alert_filters.build.region == region %>"
                           data-searchable-select-target="option"
                           data-action="mousedown->searchable-select#selectOption"
                           data-value="<%= region %>">
                        <%= region %>
                      </div>
                    <% end %>
                  </div>
                </div>

                <%= form.select :region_search,
                    content_tag(:optgroup,
                      options_for_select(JobOffer::HIGHLIGHTED_REGIONS.map { |r| [r, r] }, selected: @job_alert.job_alert_filters.build.region),
                      label: "Featured Regions"
                    ) +
                    content_tag(:optgroup,
                      options_for_select(JobOffer::REGIONS.reject { |r| JobOffer::HIGHLIGHTED_REGIONS.include?(r) }.map { |r| [r, r] }, selected: @job_alert.job_alert_filters.build.region),
                      label: "Regions"
                    ),
                    { include_blank: "All Regions" },
                    {
                      class: "hidden",
                      data: { "searchable-select-target": "select" }
                    } %>
              </div>
            </div>

            <div>
              <%= form.label :frequency, class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= form.select :frequency,
                    options_for_select([
                      ['Daily', 'daily'],
                      ['Weekly', 'weekly'],
                      ['Monthly', 'monthly']
                    ], 'weekly'),
                    {},
                    { class: "block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500 sm:text-sm bg-white" } %>
            </div>
            <%= form.hidden_field :management_token, value: @job_alert.management_token %>
          </div>

          <div class="flex justify-end">
            <%= form.submit "Add Filter",
                  class: "inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-amber-600 hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500" %>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Unsubscribe Section -->
    <div class="bg-white rounded-lg shadow-sm border border-red-200 p-6">
      <h3 class="text-lg font-medium text-red-900 mb-2">Unsubscribe</h3>
      <p class="text-sm text-red-700 mb-4">
        If you no longer want to receive job alerts, you can unsubscribe below. This action cannot be undone.
      </p>

      <%= link_to unsubscribe_job_alert_path(management_token: @job_alert.management_token),
                  data: {
                    confirm: "Are you sure you want to unsubscribe? You will stop receiving job alerts and cannot undo this action."
                  },
                  class: "inline-flex items-center px-4 py-2 border border-red-300 shadow-sm text-sm font-medium rounded-md text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors" do %>
        <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
        Unsubscribe from Job Alerts
      <% end %>
    </div>

    <!-- Back to Jobs -->
    <div class="text-center mt-8">
      <%= link_to root_path,
                  class: "inline-flex items-center text-amber-600 hover:text-amber-500 text-sm font-medium" do %>
        <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
        Back to Job Listings
      <% end %>
    </div>
  </div>
</div>
